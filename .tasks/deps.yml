version: '3'

# Dependency Management Tasks
#
# Manages CUE module dependencies for v1alpha1.

includes:
  config:
    taskfile: config.yml
    internal: true

tasks:
  # ============================================================================
  # Dependency Updates
  # ============================================================================

  update-deps:
    desc: Update CUE dependencies to latest versions
    summary: |
      Fetch latest versions of all opmodel.dev dependencies in v1alpha1
      and run tidy. Updates the checksum in versions.yml.

      Usage:
        task deps:update-deps                  # Update all deps
        task deps:update-deps DRY_RUN=true     # Preview without executing

      Requires:
        - Local registry running (task registry:start)
        - yq installed (brew install yq)

      Process:
        1. Extract opmodel.dev dependencies from module.cue
        2. Run 'cue mod get <dep>' for each (fetches latest)
        3. Run 'cue mod tidy' to clean up
        4. Recalculate and update checksum in versions.yml
    vars:
      DRY_RUN: '{{.DRY_RUN | default "false"}}'
    preconditions:
      - sh: docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}
        msg: |
          Local registry not running. Start with: task registry:start
      - sh: command -v yq >/dev/null 2>&1
        msg: "yq is required. Install: brew install yq"
    cmds:
      - |
        set -euo pipefail

        MODULE_DIR="{{.V1ALPHA1_DIR}}"
        VERSION_FILE="{{.VERSION_FILE}}"
        DRY_RUN="{{.DRY_RUN}}"

        # ── Colors ──────────────────────────────────────────────────────
        BOLD='\033[1m'
        DIM='\033[2m'
        GREEN='\033[0;32m'
        YELLOW='\033[0;33m'
        CYAN='\033[0;36m'
        RESET='\033[0m'

        # ── Helper Functions ────────────────────────────────────────────

        compute_checksum() {
          find "$MODULE_DIR" -name '*.cue' -not -path '*/cue.mod/*' | sort | xargs sha256sum | sha256sum | awk '{print $1}'
        }

        extract_deps() {
          sed -n '/^deps: {$/,/^}$/p' "$MODULE_DIR/cue.mod/module.cue" | \
            grep -oP '"opmodel\.dev/[^"]+@v[^"]*"' | tr -d '"' || true
        }

        # ── Main Execution ──────────────────────────────────────────────

        if [ "$DRY_RUN" = "true" ]; then
          echo -e "${BOLD}${CYAN}Dry run mode - no changes will be made${RESET}"
          echo ""
        fi

        echo -e "${BOLD}==> v1alpha1${RESET}"

        deps=$(extract_deps)

        if [ -z "$deps" ]; then
          echo -e "    ${DIM}No opmodel.dev dependencies${RESET}"
          exit 0
        fi

        if [ "$DRY_RUN" = "true" ]; then
          while IFS= read -r dep; do
            echo -e "    ${CYAN}Would run:${RESET} cue mod get $dep"
          done <<< "$deps"
          echo -e "    ${CYAN}Would run:${RESET} cue mod tidy"
          old_checksum=$(yq '.v1alpha1.checksum // "(none)"' "$VERSION_FILE" | tr -d '"')
          echo -e "    ${CYAN}Would update checksum:${RESET} ${DIM}${old_checksum:0:12}...${RESET} -> ${DIM}(recalculated)${RESET}"
          echo ""
          echo -e "${DIM}No changes made (dry run)${RESET}"
          exit 0
        fi

        cd "$MODULE_DIR"

        update_count=0
        while IFS= read -r dep; do
          echo -e "    ${GREEN}cue mod get${RESET} $dep"
          if ! cue mod get "$dep" 2>&1; then
            echo -e "    ${YELLOW}Warning: Failed to update $dep${RESET}"
            continue
          fi
          update_count=$((update_count + 1))
        done <<< "$deps"

        if [ $update_count -gt 0 ]; then
          echo -e "    ${GREEN}cue mod tidy${RESET}"
          if ! cue mod tidy 2>&1; then
            echo -e "    ${YELLOW}Warning: cue mod tidy failed${RESET}"
            exit 1
          fi

          cd - >/dev/null
          new_checksum=$(compute_checksum)
          yq -i ".v1alpha1.checksum = \"$new_checksum\"" "$VERSION_FILE"
          echo -e "    ${DIM}Checksum: ${new_checksum:0:12}...${RESET}"
        else
          echo -e "    ${DIM}No dependencies updated${RESET}"
        fi

        echo ""
        echo -e "${GREEN}Done${RESET}"
